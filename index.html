<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>‚ú¶ OMNI-MATRICE | L'≈íil de l'Architecte</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;0,600;0,700&family=Outfit:wght@200;300;400;500;600&family=Space+Mono:wght@400;700&display=swap');

:root {
  --bg: #010003; --tx: #f0e6fc;
  --glass: rgba(12, 6, 25, 0.4); --glass-border: rgba(255, 255, 255, 0.12);
  --c1: #9d4edd; --c2: #3a0ca3; --c3: #f72585; --c4: #00f5d4; --gold: #e5b15c; --rune: #7dbbc3;
}

*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}

body {
  min-height: 100dvh; background: var(--bg); color: var(--tx);
  font-family: 'Outfit', sans-serif; overflow-x: hidden; padding-bottom: 120px; perspective: 1200px;
}

svg.goo-filter { position: absolute; width: 0; height: 0; }

.noise-overlay { position: fixed; inset: 0; opacity: 0.35; pointer-events: none; mix-blend-mode: overlay; z-index: 1; background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E"); }

.aurora-container { position: fixed; inset: 0; z-index: 0; overflow: hidden; pointer-events: none; background: #000; transition: all 2.5s ease; }
.aurora { position: absolute; border-radius: 50%; filter: blur(100px); opacity: 0.45; mix-blend-mode: screen; animation: float 20s infinite alternate ease-in-out; }
.a1 { top: -20%; left: -10%; width: 70vw; height: 70vw; background: var(--c2); }
.a2 { bottom: -20%; right: -10%; width: 80vw; height: 80vw; background: var(--c1); animation-delay: -5s; }
.a3 { top: 30%; left: 20%; width: 60vw; height: 60vw; background: var(--c3); opacity: 0.2; animation-delay: -10s; }

@keyframes float { 0% { transform: translate(0, 0) scale(1) rotate(0deg); } 50% { transform: translate(10vw, 15vh) scale(1.1) rotate(180deg); } 100% { transform: translate(-10vw, 5vh) scale(0.9) rotate(360deg); } }

/* Th√®mes M√©ditation */
body.mode-aube .a1 { background: #00f5d4; } body.mode-aube .a2 { background: #fee440; } body.mode-aube .a3 { background: #00bbf9; }
body.mode-soir .a1 { background: #6a040f; } body.mode-soir .a2 { background: #d00000; } body.mode-soir .a3 { background: #370617; }
body.mode-epsilon .a1 { background: #1a1a2e; } body.mode-epsilon .a2 { background: #16213e; } body.mode-epsilon .a3 { background: #0f3460; }
body.mode-quantum .a1 { background: var(--gold); } body.mode-quantum .a2 { background: #fff; } body.mode-quantum .a3 { background: #ffb703; }
body.mode-pineal .a1 { background: #7209b7; } body.mode-pineal .a2 { background: #4cc9f0; } body.mode-pineal .a3 { background: #f72585; }

body.mode-ganzfeld .aurora-container { background: #ff3333; z-index: 100; animation: ganzfeldPulse 8s infinite alternate ease-in-out; }
body.mode-ganzfeld .aurora { display: none; }
body.mode-ganzfeld #APP { opacity: 0; pointer-events: none; }
@keyframes ganzfeldPulse { 0% { background: #ff3333; } 100% { background: #ff6666; } }
.btn-exit-ganzfeld { position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%); z-index: 1000; display: none; padding: 15px 30px; border-radius: 50px; background: rgba(0,0,0,0.6); border: 1px solid #fff; color: #fff; font-family: 'Space Mono'; font-size: 0.7rem; cursor: pointer; backdrop-filter: blur(10px); }
body.mode-ganzfeld .btn-exit-ganzfeld { display: block; }

/* --- VISION UI GLASS --- */
.glass {
  background: var(--glass); backdrop-filter: blur(50px); -webkit-backdrop-filter: blur(50px);
  border: 1px solid var(--glass-border); border-top: 1px solid rgba(255,255,255,0.25); border-left: 1px solid rgba(255,255,255,0.15);
  border-radius: 30px; box-shadow: 0 30px 60px rgba(0,0,0,0.8), inset 0 0 0 1px rgba(255,255,255,0.05); 
  padding: 30px; margin-bottom: 25px; position: relative; overflow: hidden; z-index: 2;
}

#APP { position: relative; z-index: 5; max-width: 850px; margin: 0 auto; padding: 20px; transition: opacity 2s; }

/* Navigation */
.tabs {
  position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 450px;
  background: rgba(5, 2, 15, 0.85); backdrop-filter: blur(60px); border: 1px solid rgba(255,255,255,0.2); 
  border-radius: 100px; padding: 8px; z-index: 999; display: flex; gap: 4px; box-shadow: 0 40px 80px rgba(0,0,0,1); transition: 0.6s;
}
.tabs.hidden { opacity: 0; transform: translate(-50%, 120px) scale(0.8); pointer-events: none; }
.tab { flex: 1; font-family: 'Space Mono'; font-size: 0.55rem; letter-spacing: 0.1em; text-transform: uppercase; color: rgba(255,255,255,.5); background: transparent; border: none; border-radius: 100px; padding: 18px 0; cursor: pointer; transition: 0.4s; }
.tab.act { background: rgba(255,255,255,0.12); color: #fff; box-shadow: inset 0 0 20px rgba(255,255,255,0.05); }

.panel { display: none; animation: fadeUp 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards; opacity: 0; transform: translateY(40px) scale(0.97); }
.panel.show { display: block; }
@keyframes fadeUp { to { opacity: 1; transform: translateY(0) scale(1); } }

h1 { font-family: 'Cinzel'; font-size: 2.2rem; font-weight: 700; color: #fff; text-align: center; margin-bottom: 25px; letter-spacing: 0.3em; text-shadow: 0 0 50px rgba(157, 78, 221, 0.8); }
h2 { font-family: 'Cinzel'; font-size: 1.4rem; color: var(--gold); text-align: center; margin-bottom: 15px; letter-spacing: 0.15em;}

.btn { width: 100%; font-family: 'Space Mono'; font-size: 0.75rem; font-weight: 700; letter-spacing: 0.2em; color: #fff; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); border-radius: 20px; padding: 24px; cursor: pointer; transition: 0.5s; text-transform: uppercase; margin-top: 10px; backdrop-filter: blur(10px); position: relative;}
.btn:hover { background: rgba(255,255,255,0.15); transform: translateY(-3px); box-shadow: 0 15px 35px rgba(0,0,0,0.6), 0 0 25px var(--c1); border-color: rgba(255,255,255,0.6); }

/* Setup */
#setupOv { position: fixed; inset: 0; z-index: 1000; background: rgba(0,0,0,.95); backdrop-filter: blur(60px); display: flex; align-items: center; justify-content: center; padding: 20px; }
.sb-inp { width: 100%; background: rgba(0,0,0,.5); border: 1px solid rgba(255,255,255,0.15); border-radius: 16px; color: #fff; font-family: 'Space Mono'; font-size: 0.8rem; padding: 18px; margin-bottom: 12px; outline: none; transition: 0.3s; text-align:center;}
.sb-inp:focus { border-color: var(--c4); box-shadow: 0 0 20px rgba(0,245,212,0.2); }

/* Dashboard R√©seaux */
.net-status { display: flex; justify-content: space-between; font-family: 'Space Mono'; font-size: 0.55rem; color: #00f5d4; margin-bottom: 20px; padding: 12px 15px; background: rgba(0,245,212,0.05); border-radius: 12px; border: 1px solid rgba(0,245,212,0.2); text-transform: uppercase;}
.ping-dot { width: 8px; height: 8px; background: #00f5d4; border-radius: 50%; box-shadow: 0 0 10px #00f5d4; animation: ping 1.5s infinite; display: inline-block; vertical-align: middle; margin-right: 5px;}
@keyframes ping { 0% { opacity: 1; transform: scale(1); } 100% { opacity: 0; transform: scale(2); } }

/* Rituels Hub */
.ritual-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px;}
.rc { text-align: center; padding: 24px 10px; border-radius: 24px; cursor: pointer; transition: 0.4s; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.02); display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative;}
.rc:hover { transform: translateY(-5px); background: rgba(255,255,255,0.08); border-color: rgba(255,255,255,0.4); box-shadow: 0 20px 40px rgba(0,0,0,0.8); }
.rc-ico { font-size: 2.2rem; margin-bottom: 10px; filter: drop-shadow(0 5px 15px rgba(255,255,255,0.3)); }
.rc-title { font-family: 'Cinzel'; font-size: 0.85rem; color: #fff; margin-bottom: 8px; font-weight: 600;}
.rc-sub { font-family: 'Space Mono'; font-size: 0.4rem; color: rgba(255,255,255,0.6); text-transform: uppercase; letter-spacing: 0.1em; line-height: 1.4;}
.rc-full { grid-column: span 2; padding: 25px; }

/* --- ORACLE: DASHBOARD ARCHITECTE --- */
.oracle-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;}
@media (max-width: 700px) { .oracle-grid { grid-template-columns: 1fr; } }

.oracle-module {
  background: rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.08); border-top: 1px solid rgba(255,255,255,0.2);
  border-radius: 24px; padding: 25px; box-shadow: inset 0 0 30px rgba(0,0,0,0.8), 0 15px 30px rgba(0,0,0,0.5);
  position: relative; overflow: hidden; display: flex; flex-direction: column;
}
.oracle-module::before { content:''; position:absolute; top:0; left:0; width:4px; height:100%; opacity: 0.8;}
.mod-bio::before { background: var(--c4); } .mod-astro::before { background: var(--c3); }
.mod-tao::before { background: #ff0054; } .mod-rune::before { background: var(--rune); }
.mod-tarot { grid-column: 1 / -1; } .mod-tarot::before { background: var(--gold); }

.mod-header { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); }
.mod-icon { font-size: 2.2rem; filter: drop-shadow(0 0 10px rgba(255,255,255,0.3)); }
.mod-title { font-family: 'Cinzel'; font-size: 1.1rem; font-weight: 700; color: #fff; letter-spacing: 0.15em; }
.mod-subtitle { font-family: 'Space Mono'; font-size: 0.5rem; color: rgba(255,255,255,0.5); text-transform: uppercase; letter-spacing: 0.15em; margin-top: 5px; }

.data-row { display: flex; flex-direction: column; gap: 12px; flex: 1; justify-content: center;}
.data-item { font-family: 'Outfit'; font-size: 0.95rem; line-height: 1.6; color: rgba(255,255,255,0.85); background: rgba(255,255,255,0.02); padding: 15px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.05);}
.data-item strong { color: var(--gold); font-family: 'Cinzel'; font-size: 1.05rem; letter-spacing: 0.05em; display:inline-block; margin-bottom: 5px; }
.api-badge { display:inline-block; padding: 4px 8px; background:rgba(255,255,255,0.1); border-radius:6px; font-size:0.45rem; font-family:'Space Mono'; color:var(--gold); border: 1px solid var(--gold); float: right;}

.bio-bar-bg { width: 100%; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; margin-top: 5px; overflow: hidden; }
.bio-bar-fill { height: 100%; border-radius: 3px; }

/* Plan√®tes Grid */
.planets-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; }
.planet-card { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; padding: 10px; text-align: center; }
.planet-sym { font-size: 1.5rem; margin-bottom: 5px; filter: drop-shadow(0 0 5px rgba(255,255,255,0.5));}
.planet-name { font-family: 'Space Mono'; font-size: 0.45rem; color: var(--gold); text-transform: uppercase; margin-bottom: 5px;}
.planet-sign { font-family: 'Cinzel'; font-size: 0.8rem; font-weight: 700; color: #fff;}

.tarot-showcase { display: flex; gap: 15px; overflow-x: auto; padding-bottom: 10px; scrollbar-width: none; }
.t-card-l { min-width: 180px; flex: 1; padding: 25px 20px; border-radius: 20px; background: linear-gradient(135deg, rgba(20,0,40,0.8), rgba(40,0,80,0.9)); border: 1px solid var(--c1); text-align: center; box-shadow: 0 15px 30px rgba(0,0,0,0.8); position: relative;}
.t-card-l .pos { position: absolute; top: -12px; left: 50%; transform: translateX(-50%); background: var(--c1); color: #fff; font-family: 'Space Mono'; font-size: 0.5rem; padding: 6px 15px; border-radius: 12px; text-transform: uppercase; letter-spacing: 0.1em; white-space: nowrap; box-shadow: 0 5px 15px rgba(157,78,221,0.5);}
.t-card-l span { font-size: 3.5rem; display: block; margin: 20px 0 15px 0; filter: drop-shadow(0 0 25px rgba(255,255,255,0.4)); }
.t-card-l .name { font-family: 'Cinzel'; font-size: 1rem; color: #fff; font-weight: 700; margin-bottom: 10px; letter-spacing: 0.1em;}
.t-card-l .mean { font-family: 'Outfit'; font-size: 0.85rem; color: rgba(255,255,255,0.7); line-height: 1.5; font-style: italic;}

.oracle-synthesis { background: linear-gradient(135deg, rgba(229,177,92,0.1), rgba(0,0,0,0.9)); border: 1px solid var(--gold); border-radius: 30px; padding: 40px; box-shadow: 0 0 50px rgba(229,177,92,0.15), inset 0 0 30px rgba(229,177,92,0.05); text-align: center;}
.oracle-synthesis::before { display: none; }
.reading-txt { font-family: 'Cormorant Garamond'; font-size: 1.5rem; font-style: italic; line-height: 1.8; color: #fff; margin-bottom: 30px;}

.loader-api { font-family: 'Space Mono'; font-size: 0.75rem; color: var(--gold); text-align: center; margin: 30px 0; animation: pulse 1.5s infinite; letter-spacing: 0.1em;}
@keyframes pulse { 50% { opacity: 0.5; } }

/* --- M√âDITATION LIQUIDE --- */
.med-container { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 50vh; position: relative; z-index: 2; filter: url('#goo'); }
.liquid-core { width: 180px; height: 180px; border-radius: 50%; background: var(--c4); position: relative; display: flex; align-items: center; justify-content: center; transition: all 1s ease; z-index: 5; }
.liquid-bubble { position: absolute; border-radius: 50%; background: inherit; width: 90px; height: 90px; top: 45px; left: 45px; transition: all 1s ease; z-index: 4; }
.med-container.inhale .liquid-core { transform: scale(1.6); background: var(--c1); box-shadow: 0 0 80px var(--c1); }
.med-container.inhale .liquid-bubble:nth-child(1) { transform: translate(-110px, -60px) scale(0.6); }
.med-container.inhale .liquid-bubble:nth-child(2) { transform: translate(110px, 60px) scale(0.9); }
.med-container.inhale .liquid-bubble:nth-child(3) { transform: translate(-60px, 130px) scale(0.7); }
.med-container.hold .liquid-core { transform: scale(1.6); background: var(--gold); box-shadow: 0 0 120px var(--gold); }
.med-container.hold .liquid-bubble { transform: translate(0, 0) scale(1); }
.med-container.exhale .liquid-core { transform: scale(0.9); background: var(--c4); }
.med-container.exhale .liquid-bubble { transform: translate(0, 0) scale(0.2); }

.med-text-overlay { position: absolute; z-index: 10; text-align: center; pointer-events: none;}
.med-text { font-family: 'Cinzel'; font-size: 1.6rem; font-weight: 700; text-shadow: 0 4px 20px rgba(0,0,0,1); color: #fff;}
.med-sub { font-family: 'Space Mono'; font-size: 0.65rem; letter-spacing: 0.25em; margin-top: 10px; color: var(--gold);}
.med-controls { display: flex; gap: 10px; width: 100%; margin-bottom: 20px; justify-content: center;}
.m-badge { padding: 10px 20px; background: rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.2); border-radius: 100px; font-family: 'Space Mono'; font-size: 0.55rem; color: #fff; }
.back-btn { font-family: 'Space Mono'; font-size: 0.7rem; color: rgba(255,255,255,0.6); background: none; border: none; cursor: pointer; margin-bottom: 30px; text-transform: uppercase; letter-spacing: 0.15em; transition: 0.3s;}
.back-btn:hover { color: #fff; transform: translateX(-5px); }
</style>
</head>
<body>

<svg class="goo-filter"><defs><filter id="goo"><feGaussianBlur in="SourceGraphic" stdDeviation="10" result="blur" /><feColorMatrix in="blur" type="matrix" values="1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 18 -7" result="goo" /><feBlend in="SourceGraphic" in2="goo" /></filter></defs></svg>

<div class="noise-overlay"></div>
<div class="aurora-container"><div class="aurora a1"></div><div class="aurora a2"></div><div class="aurora a3"></div></div>
<canvas id="particleCanvas"></canvas>

<div id="ganzfeldOverlay">
  <div class="ganz-text" id="ganzText">Le mode Ganzfeld va saturer vos sens. Gardez les yeux ouverts. Fixez l'√©cran rouge pour d√©clencher la transe visuelle.</div>
  <button class="btn-exit-ganzfeld" onclick="closeMeditation()">X QUITTER LA TRANSE</button>
</div>

<div id="setupOv">
  <div class="glass" style="width:100%; max-width:480px; text-align:center;">
    <h2 style="color:var(--gold); font-size:1.6rem;">LE CR√âATEUR</h2>
    <input class="sb-inp" id="sbName" type="text" placeholder="Pr√©nom (Pour la Gematria)">
    <div style="font-family:'Space Mono'; font-size:0.6rem; color:var(--c4); text-align:left; padding-left:10px; margin-bottom:5px;">DATE DE NAISSANCE :</div>
    <input class="sb-inp" id="sbDob" type="date" required>
    <textarea class="sb-inp" id="sbIntent" placeholder="La ligne de temps √† manifester..." style="height: 80px; resize: none; font-family:'Cormorant Garamond'; font-style:italic; font-size:1.2rem;"></textarea>
    <input class="sb-inp" id="sbApiKey" type="password" placeholder="Cl√© API Gemini (Optionnelle)" style="font-size:0.65rem; margin-bottom: 5px;">
    <button class="btn btn-gold" onclick="saveSetup()" style="margin-top: 15px;">INITIALISER L'HOLOGRAMME</button>
  </div>
</div>

<div id="APP">
  <h1 id="mainTitle">OMNI-MATRICE</h1>
  
  <div class="panel show" id="panel-hub">
    <div class="net-status">
      <span><div class="ping-dot"></div> Liaisons Sensorielles OK</span>
      <span id="kpIndexDisplay">NOAA Kp: Sync...</span>
    </div>

    <div class="glass" style="text-align:center; padding: 20px;">
      <h3 id="hubUserName" style="color: #fff; font-size: 0.8rem;">SIGNATURE QUANTIQUE</h3>
      <div style="font-family:'Space Mono'; font-size:0.65rem; color:var(--c4); margin-top:8px; letter-spacing: 0.15em;" id="uiProfileData"></div>
    </div>
    
    <div class="ritual-grid">
      <div class="rc" onclick="openMeditation('aube')" style="border-color: #00f5d4;"><div class="rc-ico" style="color:#00f5d4;">üåÖ</div><div class="rc-title">√âveil B√™ta</div><div class="rc-sub">Iso 15Hz ¬∑ Resp 6/2</div></div>
      <div class="rc" onclick="openMeditation('soir')" style="border-color: #ff0054;"><div class="rc-ico" style="color:#ff0054;">üåÜ</div><div class="rc-title">Nerf Vague</div><div class="rc-sub">Haptique ¬∑ Resp 4-7-8</div></div>
      <div class="rc rc-full" onclick="openMeditation('epsilon')" style="border-color: #4cc9f0; background: rgba(76,201,240,0.05);"><div class="rc-ico" style="color:#4cc9f0;">üåå</div><div class="rc-title" style="color:#fff; font-size: 1.1rem;">Transe Epsilon</div><div class="rc-sub" style="color:#aaa;">Bruit Rose ¬∑ 0.5Hz Epsilon ¬∑ Stase Cellulaire</div></div>
      <div class="rc" onclick="openMeditation('quantum')" style="border-color: var(--gold);"><div class="rc-ico" style="color:var(--gold);">üåÄ</div><div class="rc-title" style="color:var(--gold);">Saut Quantique</div><div class="rc-sub">Alpha 8Hz</div></div>
      <div class="rc" onclick="openMeditation('pineal')" style="border-color: rgba(157,78,221,0.5);"><div class="rc-ico" style="color:var(--star);">üîÆ</div><div class="rc-title">Glande Pin√©ale</div><div class="rc-sub">Gamma 33Hz</div></div>
      <div class="rc rc-full" onclick="openMeditation('ganzfeld')" style="border-color: #ff4d4d; background: rgba(255,77,77,0.05);"><div class="rc-ico" style="color:#ff4d4d; text-shadow: 0 0 15px #ff4d4d;">üëÅÔ∏è</div><div class="rc-title" style="color:#ff4d4d;">Effet Ganzfeld (Hallucination)</div><div class="rc-sub" style="color:#fff;">Bruit Brun ¬∑ Privation Sensorielle Visuelle Absolue</div></div>
    </div>
  </div>

  <div class="panel" id="panel-meditation">
    <button class="back-btn" onclick="closeMeditation()">‚Üê Retour</button>
    <div class="glass" id="medGlass" style="min-height: 75vh; display:flex; flex-direction:column; justify-content: space-between;">
      <div style="text-align:center;">
        <h2 id="medTitle" style="font-size: 1.8rem; letter-spacing:0.2em;">Neuro-Immersion</h2>
        <div class="med-controls"><div class="m-badge" id="ctrl-freq">Fr√©quence</div><div class="m-badge" id="ctrl-breath">Respiration</div></div>
      </div>
      
      <div style="display:flex; justify-content:center; align-items:center; flex:1; position:relative;">
        <div class="med-container" id="medContainer">
          <div class="liquid-core" id="bShapeCore"></div>
          <div class="liquid-bubble"></div><div class="liquid-bubble"></div><div class="liquid-bubble"></div>
        </div>
        <div class="med-text-overlay"><div class="med-text" id="bText">PR√äT</div><div class="med-sub" id="bSub"></div></div>
      </div>
      <button class="btn" id="btnPlayMed" onclick="toggleMeditation()">‚ñ∂ INITIER LA S√âQUENCE</button>
    </div>
  </div>

  <div class="panel" id="panel-omni">
    <button class="back-btn" onclick="switchTab('hub')">‚Üê Retour</button>
    
    <div id="omniInitial" class="glass" style="text-align:center;">
      <h2 style="color:var(--gold); font-size: 1.8rem; margin-bottom: 20px;">L'≈íIL DE L'ARCHITECTE</h2>
      <p style="font-family:'Outfit'; font-size:1.05rem; color:rgba(255,255,255,0.8); line-height: 1.6; margin-bottom: 30px;">
        Extraction des donn√©es matricielles : Biom√©trie, Tzolkin (Maya), Astrologie, Yi Jing, Runes et Tarot Akashique.
      </p>
      <button class="btn btn-gold" onclick="runLiveSynthesis()" style="padding: 25px; font-size: 0.95rem;">‚ú¶ CALCULER L'INTERF√âRENCE QUANTIQUE ‚ú¶</button>
    </div>
    
    <div id="omniLoading" class="loader-api" style="display:none;">
      ENTRELA√áEMENT DES DONN√âES EN COURS...
    </div>

    <div id="omniResult" style="display:none;">
      
      <div class="oracle-grid">
        <div class="oracle-module mod-bio">
          <div class="mod-header">
            <div class="mod-icon">üß¨</div>
            <div><div class="mod-title">SIGNATURE BIOM√âTRIQUE</div><div class="mod-subtitle">Gematria & Cycles</div></div>
          </div>
          <div class="data-row" id="html-bio"></div>
        </div>

        <div class="oracle-module mod-astro">
          <div class="mod-header">
            <div class="mod-icon">üî≠</div>
            <div><div class="mod-title">CLIMAT COSMIQUE</div><div class="mod-subtitle">Plan√®tes & Calendrier Maya (Tzolkin)</div></div>
          </div>
          <div class="data-row" id="html-astro"></div>
        </div>

        <div class="oracle-module mod-tao">
          <div class="mod-header">
            <div class="mod-icon">‚òØÔ∏è</div>
            <div><div class="mod-title">MATRICE TAO√èSTE</div><div class="mod-subtitle">I-Ching (Mutations)</div></div>
          </div>
          <div class="data-row" id="html-yijing"></div>
        </div>

        <div class="oracle-module mod-rune">
          <div class="mod-header">
            <div class="mod-icon" style="color:var(--rune);">·õâ</div>
            <div><div class="mod-title" style="color:var(--rune);">L'ANCRAGE TERRESTRE</div><div class="mod-subtitle">Rune d'Action (Elder Futhark)</div></div>
          </div>
          <div class="data-row" id="html-rune"></div>
        </div>
      </div>

      <div class="oracle-module mod-tarot">
        <div class="mod-header">
          <div class="mod-icon">üìú</div>
          <div><div class="mod-title">ARCHIVES AKASHIQUES (TAROT)</div><div class="mod-subtitle">Entropie Quantique Locale</div></div>
        </div>
        <div class="tarot-showcase" id="html-tarot"></div>
      </div>

      <div class="oracle-module oracle-synthesis">
        <h2 style="color:var(--gold); margin-bottom: 5px; font-size:1.8rem;">L'HYPER-ESPRIT</h2>
        <div style="font-family:'Space Mono'; font-size:0.55rem; color:rgba(255,255,255,0.5); text-transform:uppercase; margin-bottom: 30px;">Synth√®se Globale par R√©seau Neuronal</div>
        <div class="reading-txt" id="omniReadingTxt"></div>
        <button class="btn btn-gold" onclick="playOmniAudio()">‚ñ∂ √âCOUTER LA R√âV√âLATION</button>
      </div>

    </div>
  </div>

</div>

<div class="tabs" id="navTabs">
  <button class="tab act" onclick="switchTab('hub')">Protocoles</button>
  <button class="tab" onclick="switchTab('omni')">Le Grand Tableau</button>
</div>

<script>
/* ==========================================================================
   GESTION PROFIL & ALGORITHMES √âSOT√âRIQUES AVANC√âS
   ========================================================================== */
let UP = JSON.parse(localStorage.getItem('qm-v18-prof'));

// Gematria simple (Somme des lettres A=1...Z=26)
function getGematria(name) {
  name = name.toUpperCase().replace(/[^A-Z]/g, ''); let sum = 0;
  for(let i=0; i<name.length; i++) sum += (name.charCodeAt(i) - 64);
  let red = sum; while(red > 9 && red !== 11 && red !== 22 && red !== 33) { red = red.toString().split('').reduce((a,b)=>parseInt(a)+parseInt(b), 0); }
  return { sum: sum, reduced: red };
}

function getLifePath(dob) {
  let sum = dob.replace(/-/g, '').split('').map(Number).reduce((a, b) => a + b, 0);
  while (sum > 9 && sum !== 11 && sum !== 22 && sum !== 33) sum = sum.toString().split('').reduce((a, b) => parseInt(a) + parseInt(b), 0);
  return sum;
}

function getUniversalDay() {
  let d = new Date(); let ds = `${d.getDate()}${d.getMonth()+1}${d.getFullYear()}`;
  let sum = ds.split('').map(Number).reduce((a, b) => a + b, 0);
  while (sum > 9) sum = sum.toString().split('').reduce((a, b) => parseInt(a) + parseInt(b), 0);
  return sum;
}

// Astrologie & Plan√®tes
const ZODIAC = ['B√©lier','Taureau','G√©meaux','Cancer','Lion','Vierge','Balance','Scorpion','Sagittaire','Capricorne','Verseau','Poissons'];
function getAdvancedPlanets() {
  const d = (new Date() - new Date('2000-01-01T12:00:00Z')) / 86400000;
  const p = [{n: 'Soleil', sym: '‚òÄÔ∏è', r: 0.9856, l0: 280.46}, {n: 'Lune', sym: 'üåô', r: 13.1764, l0: 218.32}, {n: 'Mercure', sym: '‚òøÔ∏è', r: 4.0923, l0: 252.25}, {n: 'V√©nus', sym: '‚ôÄÔ∏è', r: 1.6021, l0: 181.98}, {n: 'Mars', sym: '‚ôÇÔ∏è', r: 0.5240, l0: 355.45}];
  return p.map(x => { return {...x, sign: ZODIAC[Math.floor((((x.l0 + x.r * d) % 360 + 360) % 360)/30)]}; });
}
function getMoonPhase() {
  let lp = 2551443; let now = new Date(); let newMoon = new Date(1970, 0, 7, 20, 35, 0);
  let phase = ((now.getTime() - newMoon.getTime())/1000) % lp; let days = Math.floor(phase /(24*3600));
  if (days < 2) return { n: "Nouvelle Lune", c: "Ancrage des intentions." };
  if (days < 7) return { n: "Premier Croissant", c: "√ânergie montante." };
  if (days < 14) return { n: "Premier Quartier", c: "Friction et d√©fi." };
  if (days < 16) return { n: "Pleine Lune", c: "Apog√©e √©nerg√©tique." };
  if (days < 22) return { n: "Lune Gibbeuse", c: "Gratitude." };
  if (days < 28) return { n: "Dernier Quartier", c: "L√¢cher-prise." };
  return { n: "Lune Balsamique", c: "Vide quantique." };
}

// Biorhythmes
function getBiorhythms(dob) {
  let days = Math.floor((new Date() - new Date(dob)) / (1000 * 60 * 60 * 24));
  return { phy: Math.round(Math.sin((2 * Math.PI * days) / 23) * 100), emo: Math.round(Math.sin((2 * Math.PI * days) / 28) * 100), int: Math.round(Math.sin((2 * Math.PI * days) / 33) * 100) };
}

// Calendrier Maya (Tzolkin de la journ√©e)
const MAYAN_SEALS = ["Soleil Jaune (Ahau)", "Dragon Rouge (Imix)", "Vent Blanc (Ik)", "Nuit Bleue (Akbal)", "Graine Jaune (Kan)", "Serpent Rouge (Chicchan)", "Enlaceur des Mondes (Cimi)", "Main Bleue (Manik)", "√âtoile Jaune (Lamat)", "Lune Rouge (Muluc)", "Chien Blanc (Oc)", "Singe Bleu (Chuen)", "Humain Jaune (Eb)", "Voyageur du Ciel (Ben)", "Magicien Blanc (Ix)", "Aigle Bleu (Men)", "Guerrier Jaune (Cib)", "Terre Rouge (Caban)", "Miroir Blanc (Etznab)", "Temp√™te Bleue (Cauac)"];
const MAYAN_TONES = ["Magn√©tique (1)", "Lunaire (2)", "√âlectrique (3)", "Auto-existant (4)", "Harmonique (5)", "Rythmique (6)", "R√©sonnant (7)", "Galactique (8)", "Solaire (9)", "Plan√©taire (10)", "Spectral (11)", "Cristal (12)", "Cosmique (13)"];
function getMayanKin() {
  // Approximation : Jours √©coul√©s depuis le 1er Janvier 2000 (√âtait Kin 92)
  let days = Math.floor((new Date() - new Date('2000-01-01T00:00:00Z')) / 86400000);
  let kin = (92 + days) % 260; if(kin <= 0) kin += 260;
  let tone = MAYAN_TONES[(kin - 1) % 13]; let seal = MAYAN_SEALS[(kin - 1) % 20];
  return { kin: kin, tone: tone, seal: seal };
}

function saveSetup() {
  const n = document.getElementById('sbName').value.trim(); const dob = document.getElementById('sbDob').value; 
  const intent = document.getElementById('sbIntent').value.trim(); const apiKey = document.getElementById('sbApiKey').value.trim();
  if(!dob || !intent) return alert("Date et Intention requises.");
  let gem = getGematria(n);
  UP = { name: n || 'Ame', dob: dob, intent: intent, gematria: gem, lifePath: getLifePath(dob), aiKey: apiKey };
  localStorage.setItem('qm-v18-prof', JSON.stringify(UP));
  document.getElementById('setupOv').style.display = 'none';
  document.getElementById('uiProfileData').innerText = `CHEMIN ${UP.lifePath} | VIBRATION NOM ${UP.gematria.reduced}`;
}
if(UP && UP.dob) { document.getElementById('setupOv').style.display = 'none'; document.getElementById('uiProfileData').innerText = `CHEMIN ${UP.lifePath} | VIBRATION NOM ${UP.gematria.reduced}`; }

/* ==========================================================================
   ORACLES: YI JING, RUNES, TAROT
   ========================================================================== */
const I_CHING = [{n: "1. Le Cr√©ateur", m: "Action forte, yang pur."}, {n: "2. Le R√©ceptif", m: "Patience, accueil."}, {n: "11. La Paix", m: "Harmonie ciel/terre."}, {n: "12. La Stagnation", m: "Blocage temporaire."}, {n: "24. Le Retour", m: "Un nouveau cycle commence."}, {n: "46. La Pouss√©e", m: "Croissance continue."}, {n: "63. Apr√®s l'Accomplissement", m: "L'ordre est √©tabli."}];
function castIChing() { return { hex: I_CHING[Math.floor(Math.random() * I_CHING.length)], lineMsg: `Ligne Mutante ${Math.floor(Math.random() * 6) + 1} : L'√©nergie bascule.` }; }

const RUNES = [
  {n:'Fehu ·ö†', m:'Richesse, √©nergie de cr√©ation.'}, {n:'Uruz ·ö¢', m:'Force vitale, sant√© brute.'}, {n:'Thurisaz ·ö¶', m:'Destruction des obstacles.'}, {n:'Ansuz ·ö®', m:'Sagesse, communication.'}, {n:'Raidho ·ö±', m:'Le voyage, le mouvement align√©.'}, {n:'Kenaz ·ö≤', m:'L\'illumination, la r√©v√©lation.'}, {n:'Gebo ·ö∑', m:'Le don, l\'√©change parfait.'}, {n:'Wunjo ·öπ', m:'La joie, l\'harmonie totale.'}, {n:'Hagalaz ·ö∫', m:'La temp√™te, la purification radicale.'}, {n:'Naudhiz ·öæ', m:'Le besoin, la r√©sistance utile.'}, {n:'Isa ·õÅ', m:'La glace, la pause n√©cessaire.'}, {n:'Jera ·õÉ', m:'La r√©colte, le cycle naturel.'}, {n:'Eihwaz ·õá', m:'L\'arbre de vie, la transformation.'}, {n:'Perthro ·õà', m:'Le myst√®re, le destin quantique.'}, {n:'Algiz ·õâ', m:'La protection divine.'}, {n:'Sowilo ·õä', m:'Le soleil, la victoire certaine.'}, {n:'Tiwaz ·õè', m:'La justice, la volont√© focalis√©e.'}, {n:'Berkano ·õí', m:'La croissance, la fertilit√©.'}, {n:'Ehwaz ·õñ', m:'Le partenariat, la progression.'}, {n:'Mannaz ·õó', m:'L\'humanit√©, le r√©seau social.'}, {n:'Laguz ·õö', m:'L\'eau, l\'intuition fluide.'}, {n:'Ingwaz ·õú', m:'La graine, le potentiel interne.'}, {n:'Dagaz ·õû', m:'L\'aube, le changement radical.'}, {n:'Othala ·õü', m:'L\'h√©ritage, la fondation solide.'}
];
function castRune() { return RUNES[Math.floor(Math.random() * RUNES.length)]; }

const TAROT_FR = [
  {n:'Le Mat',i:'üéí', k:'Le saut dans le vide quantique. Aucune limite.'}, {n:'Le Bateleur',i:'üÉè', k:'Toutes les ressources sont l√†. Cr√©ez.'},
  {n:'La Papesse',i:'üé¥', k:'Lecture des annales akashiques. Intuition.'}, {n:'L\'Imp√©ratrice',i:'üëë', k:'Incubation et naissance abondante.'},
  {n:'L\'Empereur',i:'üõ°Ô∏è', k:'Ancrage de l\'√©nergie dans la mati√®re.'}, {n:'Le Pape',i:'üìú', k:'Alignement avec votre contrat d\'√¢me.'},
  {n:'L\'Amoureux',i:'üíû', k:'Intrication quantique. Un choix vibratoire.'}, {n:'Le Chariot',i:'üèá', k:'Effondrement conscient de la probabilit√©.'},
  {n:'La Justice',i:'‚öñÔ∏è', k:'R√©√©quilibrage karmique absolu.'}, {n:'L\'Ermite',i:'üèÆ', k:'D√©connexion de la Matrice. Retraite.'},
  {n:'La Roue',i:'üé°', k:'Synchronicit√©s acc√©l√©r√©es. Le cycle tourne.'}, {n:'La Force',i:'ü¶Å', k:'Ma√Ætrise √©pig√©n√©tique des instincts.'},
  {n:'Le Pendu',i:'ü™¢', k:'Inversion de perspective. L√¢cher-prise.'}, {n:'L\'Arcane Sans Nom',i:'üíÄ', k:'Mort de l\'ancien ego. Transmutation.'},
  {n:'La Temp√©rance',i:'üåä', k:'Coh√©rence c≈ìur-cerveau. Alchimie.'}, {n:'Le Diable',i:'‚õìÔ∏è', k:'D√©tachement des croyances de la 3D.'},
  {n:'La Maison Dieu',i:'‚ö°', k:'Choc lib√©rateur. Les fondations s\'effondrent.'}, {n:'L\'√âtoile',i:'‚≠ê', k:'Guidance pure des royaumes stellaires.'},
  {n:'La Lune',i:'üåô', k:'Exploration des peurs subconscientes.'}, {n:'Le Soleil',i:'‚òÄÔ∏è', k:'Illumination totale. Succ√®s radieux.'},
  {n:'Le Jugement',i:'üìØ', k:'L\'√©veil final de votre conscience.'}, {n:'Le Monde',i:'üåç', k:'L\'accomplissement holographique parfait.'}
];
function getQuantumTarot() {
  let deck = [...TAROT_FR]; let drawn = [];
  for(let i=0; i<3; i++) {
    let arr = new Uint32Array(1); window.crypto.getRandomValues(arr);
    let index = arr[0] % deck.length; drawn.push(deck[index]); deck.splice(index, 1);
  }
  return drawn;
}

/* ==========================================================================
   LE GRAND TABLEAU (FETCH API & SYNTH√àSE)
   ========================================================================== */
let currentKp = "N/A";
fetch('https://services.swpc.noaa.gov/products/noaa-planetary-k-index.json').then(r=>r.json()).then(d=>{currentKp = parseFloat(d[d.length-1][1]); document.getElementById('kpIndexDisplay').innerHTML=`NOAA Kp: ${currentKp}`;}).catch(e=>{});

function formatColor(val) { return val > 0 ? '#00f5d4' : (val < 0 ? '#f72585' : '#e5b15c'); }

async function runLiveSynthesis() {
  document.getElementById('omniInitial').style.display = 'none';
  document.getElementById('omniLoading').style.display = 'block';

  // 1. Biom√©trie & Gematria
  let bio = getBiorhythms(UP.dob); let univDay = getUniversalDay();
  document.getElementById('html-bio').innerHTML = `
    <div class="data-item"><span class="api-badge">GEMATRIA</span><strong>Vibration du Pr√©nom : ${UP.gematria.reduced}</strong> (Chemin: ${UP.lifePath})</div>
    <div class="data-item"><span class="api-badge">NUM√âROLOGIE</span><strong>Jour Universel : ${univDay}</strong></div>
    <div class="data-item" style="margin-top:10px;">
      <div style="font-family:'Space Mono'; font-size:0.6rem; display:flex; justify-content:space-between;"><span>Physique</span> <span style="color:${formatColor(bio.phy)}">${bio.phy}%</span></div>
      <div class="bio-bar-bg"><div class="bio-bar-fill" style="width:${(bio.phy+100)/2}%; background:${formatColor(bio.phy)};"></div></div>
      <div style="font-family:'Space Mono'; font-size:0.6rem; display:flex; justify-content:space-between; margin-top:8px;"><span>√âmotionnel</span> <span style="color:${formatColor(bio.emo)}">${bio.emo}%</span></div>
      <div class="bio-bar-bg"><div class="bio-bar-fill" style="width:${(bio.emo+100)/2}%; background:${formatColor(bio.emo)};"></div></div>
      <div style="font-family:'Space Mono'; font-size:0.6rem; display:flex; justify-content:space-between; margin-top:8px;"><span>Intellectuel</span> <span style="color:${formatColor(bio.int)}">${bio.int}%</span></div>
      <div class="bio-bar-bg"><div class="bio-bar-fill" style="width:${(bio.int+100)/2}%; background:${formatColor(bio.int)};"></div></div>
    </div>
  `;

  // 2. Astro & Maya
  let moon = getMoonPhase(); let planets = getAdvancedPlanets(); let maya = getMayanKin();
  let planetsHtml = planets.map(p => `<div class="planet-card"><div class="planet-sym">${p.sym}</div><div class="planet-name">${p.n}</div><div class="planet-sign">${p.sign}</div></div>`).join('');
  document.getElementById('html-astro').innerHTML = `
    <div class="data-item"><span class="api-badge">TZOLKIN</span><strong>Sceau Maya : ${maya.seal}</strong> Tonalit√© ${maya.tone}. (Kin ${maya.kin})</div>
    <div class="data-item"><span class="api-badge">NOAA</span><strong>M√©t√©o Spatiale (Kp) : ${currentKp}</strong></div>
    <div class="data-item"><span class="api-badge">LUNE</span><strong>Phase : ${moon.n}</strong></div>
    <div class="planets-grid" style="margin-top:15px;">${planetsHtml}</div>
  `;

  // 3. Yi Jing
  let yj = castIChing();
  document.getElementById('html-yijing').innerHTML = `<div class="data-item"><span class="api-badge">TAO</span><strong>Hexagramme : ${yj.hex.n}</strong> ${yj.hex.m}<br><br><em>${yj.lineMsg}</em></div>`;

  // 4. Runes
  let rune = castRune();
  document.getElementById('html-rune').innerHTML = `<div class="data-item"><span class="api-badge" style="border-color:var(--rune); color:var(--rune);">FUTHARK</span><strong>Rune du Jour : ${rune.n}</strong><br>${rune.m}</div>`;

  // 5. Tarot
  let tarotCards = getQuantumTarot();
  let pos = ["L'ONDE PASS√âE (L'Ancrage)", "LE POINT Z√âRO (Le Pr√©sent)", "LA LIGNE DE TEMPS (Le Futur)"];
  document.getElementById('html-tarot').innerHTML = tarotCards.map((c, i) => `<div class="t-card-l"><div class="pos">${pos[i]}</div><span>${c.i}</span><div class="name">${c.n}</div><div class="mean">${c.k}</div></div>`).join('');

  // 6. Synth√®se LLM Gemini
  let finalTxt = "";
  if(UP.aiKey && UP.aiKey.length > 10) {
    try {
      let prompt = `Agis comme l'Hyper-Esprit, l'Oracle Ultime. Analyse l'intention de ${UP.name} : "${UP.intent}". 
      Donn√©es crois√©es : Gematria nom (${UP.gematria.reduced}), Sceau Maya (${maya.seal}), Lune (${moon.n}), Yi Jing (${yj.hex.n}), Rune Nordique (${rune.n}), Tarot (${tarotCards[1].n}). 
      Fais une synth√®se Magistrale, mystique et percutante de 5 phrases maximum en fran√ßais pour lui dire comment manifester son intention aujourd'hui. Ne mets AUCUN ast√©risque ni texte en gras.`;
      
      let aiRes = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${UP.aiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });
      let aiData = await aiRes.json();
      if(aiData.error) throw new Error(aiData.error.message);
      finalTxt = aiData.candidates[0].content.parts[0].text;
    } catch(e) { finalTxt = "L'acc√®s √† la cl√© Gemini a √©chou√©. " + generateLocalSynthesis(tarotCards, yj.hex.n, rune.n); }
  } else { finalTxt = generateLocalSynthesis(tarotCards, yj.hex.n, rune.n); }

  document.getElementById('omniReadingTxt').innerText = finalTxt;
  document.getElementById('omniLoading').style.display = 'none'; document.getElementById('omniResult').style.display = 'block';
}

function generateLocalSynthesis(cards, hex, rune) { return `La grille holographique est en place, ${UP.name}. Votre intention "${UP.intent}" r√©sonne avec le flux de l'hexagramme ${hex}. La pr√©sence de ${cards[1].n} au point z√©ro vous demande un l√¢cher-prise imm√©diat. Appuyez-vous sur la force terrestre de la rune ${rune} pour ancrer votre d√©sir. Vibrez d√®s maintenant la r√©alit√© de ${cards[2].n}. L'univers ex√©cute votre commande.`; }

/* ==========================================================================
   NEURO-SYNTH ULTRA (Sons, Voix, Haptique)
   ========================================================================== */
class NeuroSynthUltra {
  constructor() { this.ctx = null; this.isPlaying = false; this.nodes = []; }
  init() { if(!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)(); }

  createPinkNoise() {
    let bs = 2 * this.ctx.sampleRate; let nb = this.ctx.createBuffer(1, bs, this.ctx.sampleRate);
    let out = nb.getChannelData(0); let b0=0, b1=0, b2=0, b3=0, b4=0, b5=0, b6=0;
    for (let i = 0; i < bs; i++) { let w = Math.random() * 2 - 1; b0 = 0.99886*b0+w*0.0555; b1 = 0.99332*b1+w*0.0750; b2 = 0.96900*b2+w*0.1538; b3 = 0.86650*b3+w*0.3104; b4 = 0.55000*b4+w*0.5329; b5 = -0.7616*b5-w*0.0168; out[i] = b0+b1+b2+b3+b4+b5+b6+w*0.5362; out[i]*=0.11; b6 = w*0.1159; }
    let ns = this.ctx.createBufferSource(); ns.buffer = nb; ns.loop = true; return ns;
  }
  
  createBrownNoise() {
    let bs = 2 * this.ctx.sampleRate; let nb = this.ctx.createBuffer(1, bs, this.ctx.sampleRate);
    let out = nb.getChannelData(0); let lastOut = 0;
    for (let i = 0; i < bs; i++) { let w = Math.random() * 2 - 1; out[i] = (lastOut + (0.02 * w)) / 1.02; lastOut = out[i]; out[i] *= 3.5; }
    let ns = this.ctx.createBufferSource(); ns.buffer = nb; ns.loop = true; return ns;
  }

  start(baseFreq, targetHz, noiseType = null) {
    this.init(); this.ctx.resume();
    this.master = this.ctx.createGain(); this.master.gain.setValueAtTime(0, this.ctx.currentTime); 
    this.master.gain.linearRampToValueAtTime(0.08, this.ctx.currentTime + 3); this.master.connect(this.ctx.destination);
    
    if(noiseType === 'pink') { let pn = this.createPinkNoise(); let f = this.ctx.createBiquadFilter(); f.type = 'lowpass'; f.frequency.value = 600; pn.connect(f).connect(this.master); pn.start(); this.nodes.push(pn); } 
    else if(noiseType === 'brown') { let bn = this.createBrownNoise(); let f = this.ctx.createBiquadFilter(); f.type = 'lowpass'; f.frequency.value = 400; bn.connect(f).connect(this.master); bn.start(); this.nodes.push(bn); }
    
    let osc = this.ctx.createOscillator(); osc.frequency.value = baseFreq;
    let isoGain = this.ctx.createGain(); isoGain.gain.value = 0.5;
    let lfo = this.ctx.createOscillator(); lfo.type = 'sine'; lfo.frequency.value = targetHz;
    let lfoDepth = this.ctx.createGain(); lfoDepth.gain.value = 0.5;
    lfo.connect(lfoDepth).connect(isoGain.gain); osc.connect(isoGain).connect(this.master);
    osc.start(); lfo.start(); this.nodes.push(osc, lfo); this.isPlaying = true;
  }

  playCue(type) {
    if(!this.ctx) return;
    let b = this.ctx.createOscillator(); let g = this.ctx.createGain();
    b.connect(g).connect(this.ctx.destination); let now = this.ctx.currentTime;
    g.gain.setValueAtTime(0, now); g.gain.linearRampToValueAtTime(0.15, now + 0.05); g.gain.exponentialRampToValueAtTime(0.001, now + 3);
    if(type === 'inhale') { b.type = 'sine'; b.frequency.setValueAtTime(432, now); b.frequency.exponentialRampToValueAtTime(864, now + 0.5); } 
    else if(type === 'hold') { b.type = 'triangle'; b.frequency.setValueAtTime(528, now); } 
    else if(type === 'exhale') { b.type = 'sine'; b.frequency.setValueAtTime(432, now); b.frequency.exponentialRampToValueAtTime(216, now + 1); } 
    b.start(now); b.stop(now + 3);
  }

  stop() {
    if(!this.isPlaying) return; this.master.gain.linearRampToValueAtTime(0, this.ctx.currentTime + 1);
    setTimeout(() => { this.nodes.forEach(n => { try{n.stop();}catch(e){} }); this.nodes = []; this.isPlaying = false; }, 1500);
  }
}
const audioEngine = new NeuroSynthUltra();

const OrganicVoice = {
  synth: window.speechSynthesis,
  speak(text, speed = 0.85, pitch = 0.9) {
    this.synth.cancel(); let chunks = text.match(/[^.!?]+[.!?]+/g) || [text]; let idx = 0;
    let v = this.synth.getVoices().find(x => x.lang.startsWith('fr') && (x.name.includes('Premium') || x.name.includes('Thomas'))) || this.synth.getVoices().find(x => x.lang.startsWith('fr'));
    const playNext = () => {
      if(idx >= chunks.length) return; let u = new SpeechSynthesisUtterance(chunks[idx].trim());
      if(v) u.voice = v; u.rate = speed; u.pitch = pitch;
      u.onend = () => { idx++; setTimeout(playNext, speed < 0.8 ? 1000 : 400); }; this.synth.speak(u);
    }; playNext();
  }, stop() { this.synth.cancel(); }
};

function playOmniAudio() { OrganicVoice.speak(document.getElementById('omniReadingTxt').innerText, 0.85, 0.95); }
function pulseHaptic() { if(navigator.vibrate) navigator.vibrate([40, 60, 40]); }

/* ==========================================================================
   LOGIQUE DE M√âDITATION
   ========================================================================== */
let med = { id: '', active: false, interval: null, step: 0 };

function openMeditation(id) {
  med.id = id; document.getElementById('navTabs').classList.add('hidden'); document.body.className = `mode-${id}`;
  if(id === 'ganzfeld') {
      document.getElementById('ganzfeldOverlay').style.display = 'flex';
      setTimeout(() => { document.getElementById('ganzText').innerText = ""; audioEngine.start(432, 6, 'brown'); }, 5000);
      med.active = true; return;
  }
  const title = document.getElementById('medTitle'); const freq = document.getElementById('ctrl-freq'); const breath = document.getElementById('ctrl-breath');
  document.getElementById('medContainer').className = 'med-container'; document.getElementById('bText').innerHTML = "PR√äT"; document.getElementById('bSub').innerHTML = "";
  
  if(id === 'aube') { title.innerText = '√âveil Dynamique'; freq.innerText = 'Isochrone 15Hz'; breath.innerText = '6s IN / 2s OUT'; } 
  else if(id === 'soir') { title.innerText = 'Apaisement Vagal'; freq.innerText = 'Isochrone 2Hz'; breath.innerText = '4-7-8 + Haptique'; } 
  else if(id === 'epsilon') { title.innerText = 'Transe Epsilon'; freq.innerText = 'Bruit Rose + 0.5Hz'; breath.innerText = 'Respiration Libre'; } 
  else if(id === 'quantum') { title.innerText = 'Saut Quantique'; freq.innerText = 'Alpha 8Hz'; breath.innerText = 'Visualisation'; } 
  else if(id === 'pineal') { title.innerText = 'Glande Pin√©ale'; freq.innerText = 'Gamma 33Hz'; breath.innerText = 'Compression'; }
  switchTab('meditation');
}

function updateShape(cssClass, txt, subTxt) {
  document.getElementById('medContainer').className = `med-container ${cssClass}`;
  document.getElementById('bText').innerHTML = txt; document.getElementById('bSub').innerHTML = subTxt;
}

function toggleMeditation() {
  const btn = document.getElementById('btnPlayMed');
  if(med.active) { med.active = false; clearTimeout(med.interval); audioEngine.stop(); OrganicVoice.stop(); btn.innerText = "‚ñ∂ INITIER LA S√âQUENCE"; updateShape('', 'PR√äT', ''); return; }

  med.active = true; med.step = 0; btn.innerText = "‚èπ ABORTER LA S√âQUENCE";

  if(med.id === 'aube') {
    audioEngine.start(432, 15, null);
    const cycle = () => { if(!med.active) return;
      if(med.step % 2 === 0) { updateShape('inhale', 'INSPIRER', '6 SECONDES'); audioEngine.playCue('inhale'); } 
      else { updateShape('exhale', 'EXPIRER', '2 SECONDES'); audioEngine.playCue('exhale'); }
      med.step++; med.interval = setTimeout(cycle, (med.step % 2 !== 0) ? 6000 : 2000);
    }; cycle();
  } else if(med.id === 'soir') {
    audioEngine.start(396, 2, null);
    const cycle = () => { if(!med.active) return; let s = med.step % 3;
      if(s === 0) { updateShape('inhale', 'INSPIRER', '4 SECONDES'); audioEngine.playCue('inhale'); pulseHaptic(); setTimeout(pulseHaptic, 1000); setTimeout(pulseHaptic, 2000); setTimeout(pulseHaptic, 3000); } 
      else if(s === 1) { updateShape('hold', 'RETENIR', '7 SECONDES'); audioEngine.playCue('hold'); } 
      else { updateShape('exhale', 'EXPIRER', '8 SECONDES'); audioEngine.playCue('exhale'); }
      med.step++; med.interval = setTimeout(cycle, s === 0 ? 4000 : (s === 1 ? 7000 : 8000));
    }; cycle();
  } else if(med.id === 'epsilon') {
    audioEngine.start(432, 0.5, 'pink'); OrganicVoice.speak("Onde Epsilon.", 0.75, 0.8);
    const cycle = () => { if(!med.active) return;
      if(med.step % 2 === 0) { updateShape('inhale', 'INSPIRER', 'LENTEMENT'); } else { updateShape('exhale', 'EXPIRER', 'RELACHER'); }
      med.step++; med.interval = setTimeout(cycle, 10000);
    }; cycle();
  } else if(med.id === 'quantum') {
    audioEngine.start(528, 8, null); updateShape('hold', 'SAUT<br>QUANTIQUE', UP.intent.substring(0,20)+'...');
    OrganicVoice.speak(`Onde Alpha. Ressentez l'√©motion de : ${UP.intent}. C'est accompli.`, 0.8, 0.9);
  } else if(med.id === 'pineal') {
    audioEngine.start(963, 33, null);
    const cycle = () => { if(!med.active) return;
      if(med.step % 2 === 0) { updateShape('inhale', 'INSPIRER', 'COMPRESSER LE P√âRIN√âE'); audioEngine.playCue('inhale'); } 
      else { updateShape('hold', 'MAINTENIR', 'ATTENTION AU 3√àME ≈íIL'); audioEngine.playCue('hold'); }
      med.step++; med.interval = setTimeout(cycle, (med.step % 2 !== 0) ? 5000 : 10000);
    }; cycle();
  }
}

function closeMeditation() { med.active = false; clearTimeout(med.interval); audioEngine.stop(); OrganicVoice.stop(); document.body.className = ''; document.getElementById('ganzfeldOverlay').style.display = 'none'; document.getElementById('navTabs').classList.remove('hidden'); switchTab('hub'); }
function switchTab(id) { document.querySelectorAll('.tab').forEach(t => t.classList.remove('act')); if(event && event.target && event.target.classList) event.target.classList.add('act'); document.querySelectorAll('.panel').forEach(p => p.classList.remove('show')); document.getElementById('panel-' + id).classList.add('show'); }

// Init Particles
for(let i=0; i<80; i++) { let d = document.createElement('div'); d.style.position = 'absolute'; d.style.width = Math.random()*3+'px'; d.style.height = d.style.width; d.style.background = '#fff'; d.style.borderRadius = '50%'; d.style.left = Math.random()*100+'vw'; d.style.top = Math.random()*100+'vh'; d.style.opacity = Math.random()*0.5; d.style.pointerEvents = 'none'; d.style.animation = `float ${10+Math.random()*20}s infinite alternate linear`; document.body.appendChild(d); }
</script>
</body>
</html>